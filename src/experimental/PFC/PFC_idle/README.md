# PFC_idle 主动聊天功能模块

`PFC_idle` 用于实现聊天机器人的空闲时主动聊天功能。该功能旨在让机器人在没有用户主动发起对话时，能够根据用户关系、活跃度、历史记录等因素，选择时机和用户，并发起对话。

## 模块概览

以下是主要模块及其功能摘要：

*   **`__init__.py`**:
    *   作为包的入口点，定义了 `PFC_idle` 包。
    *   主要导出 `IdleChat` 类，方便外部模块调用主动聊天功能。

*   **`idle_chat.py`**:
    *   包含核心的 `IdleChat` 类。
    *   负责生成主动聊天的具体内容，如开场白。
    *   根据用户特征、聊天历史和机器人人格进行（智能）决策。
    *   在成功发送一次消息后为对应的私聊规划下一次主动聊天的时机。
    *   包含与大语言模型（LLM）交互的逻辑，用于生成对话内容，并带有重试和超时机制。

*   **`idle_conversation.py`**:
    *   包含 `IdleConversation` 类。
    *   主要负责在 `idle_chat` 成功发送主动聊天消息后，启动 PFC的对话实例。
    *   确保主动聊天能够平滑地过渡到 PFC 系统的标准对话流程中（现阶段未实现主动进入wait状态  25.5.21）。

*   **`idle_manager.py`**:
    *   包含 `IdleManager` 类，是整个主动聊天功能的总控制器。
    *   管理所有的 `IdleChat` 实例。
    *   通过一个全局的检查循环来决定何时触发主动聊天。
    *   根据`idle_weight.py`，选择最合适的用户发起聊天。
    *   负责初始化所有符合条件的私聊流，为其创建 `IdleChat` 实例。
    *   管理全局状态，如等待回复的用户列表、已尝试的用户集合以及全局触发时间。
    *   处理和触发预定的聊天任务。

*   **`idle_planner.py`**:
    *   包含 `IdlePlanner` 类。
    *   本功能的**老大哥**，专注于决策“是否”应该发起一次主动聊天。
    *   通过调用大语言模型（LLM），综合评估用户关系、上次互动时间、机器人当前状态、聊天历史、用户兴趣等多种因素。
    *   输出决策结果（是/否）以及做出该决策的理由，并可能提供建议的聊天话题。
    *   包含决策缓存和用户冷却机制。

*   **`idle_weight.py`**:
    *   提供与权重计算相关的辅助函数。
    *    根据关系等级调整基础的触发概率。
    *   优先考虑关系等级，关系等级越高权重越大。在同一关系等级内，精确的关系值会进一步微调权重。如果用户处于待回复状态，其权重会显著降低。（答应我，不要冷落他/她们好吗）


## 工作流程简述

1.  **初始化**: `IdleManager` 初始化并为所有符合条件的私聊用户创建 `IdleChat` 实例。
2.  **全局检查**: `IdleManager` 的全局检查循环会定期运行，判断当前是否适合发起主动聊天（考虑全局冷却时间、活动时间等）。
3.  **用户选择**: 如果适合发起聊天，`IdleManager` 会根据 `idle_weight` 模块计算出的用户权重，选择一个目标用户。
4.  **决策**: 选定用户后，对应用户的 `IdleChat` 实例会调用 `IdlePlanner` 来决策是否真的要向该用户发起聊天。`IdlePlanner` 会利用 LLM 进行综合评估。
5.  **内容生成与发送**: 如果 `IdlePlanner` 决定聊天，`IdleChat` 实例会再次调用 LLM 生成具体的聊天内容，并通过消息发送模块发送给用户。
6.  **对话实例启动**: 消息发送成功后，`IdleConversation` 会介入，确保为该用户启动一个 PFC 对话实例。
7.  **后续计划**: `IdleChat` 会计划下一次与该用户主动聊天的可能时间。
8.  **用户回复处理**: 当用户回复主动聊天消息时，`IdleManager` 会记录该回复，并将用户从等待回复列表中移除，同时可能会重新评估与该用户的下一次聊天计划。

本介绍由AI生成，请注意甄别，以实际代码为准

## TODO

- 1.重构为单例实现idle功能
- 2.优化主动回复prompt（未来也许不会现在这么生硬）
- 3.优化idle的逻辑与PFC功能的联动效果
- 4.允许通过群聊触发idle功能，同时扩展到群聊
- 5.学习用户的生活习惯和活跃时间，以优化idle的触发时机


